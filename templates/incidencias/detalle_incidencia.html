{% extends "base.html" %}

{% block title %}Incidencia {{ incidencia.id }} | Incidex{% endblock %}

{% block content %}

<h2>{{ incidencia.titulo }}</h2>

<p><strong>Descripción:</strong></p>
<p>{{ incidencia.descripcion }}</p>

<ul>
    <li><strong>Estado:</strong> {{ incidencia.estado }}</li>
    <li><strong>Criticidad:</strong> {{ incidencia.criticidad }}</li>
    <li><strong>Tipo:</strong> {{ incidencia.tipo_incidencia }}</li>
    <li><strong>Fecha de creación:</strong> {{ incidencia.fecha_creacion }}</li>
    <li><strong>Usuario creador:</strong> {{ incidencia.usuario_creador.username }}</li>
    <li>
        <strong>Técnico asignado:</strong>
        {% if incidencia.tecnico_asignado %}
            {{ incidencia.tecnico_asignado.usuario.username }}
        {% else %}
            Sin asignar
        {% endif %}
    </li>
</ul>

<hr>

{# === ACCIONES DEL TÉCNICO === #}

{% if es_tecnico %}

    {% if puede_autoasignar %}
        <form method="post"
              action="{% url 'autoasignar_incidencia' incidencia.id %}">
            {% csrf_token %}
            <button type="submit">Asignarme esta incidencia</button>
        </form>
    {% endif %}

    {% if es_tecnico_asignado %}
        <h3>Cambiar estado</h3>

        <form method="post"
              action="{% url 'cambiar_estado_incidencia' incidencia.id %}">
            {% csrf_token %}
            <select name="estado">
                <option value="">-- Seleccionar estado --</option>
                <option value="pendiente">Pendiente</option>
                <option value="en_espera">En espera</option>
                <option value="resuelto">Resuelto</option>
                <option value="cerrado">Cerrado</option>
            </select>
            <button type="submit">Actualizar estado</button>
        </form>
    {% endif %}

{% endif %}

<hr>

<h3>Historial de estados</h3>

{% if historial %}
    <ul>
    {% for h in historial %}
        <li>
            {{ h.fecha_cambio|date:"d/m/Y H:i" }} –
            {{ h.estado_anterior }} → {{ h.estado_nuevo }}
            {% if h.cambiado_por %}
                ({{ h.cambiado_por.username }})
            {% endif %}
        </li>
    {% endfor %}
    </ul>
{% else %}
    <p>No hay cambios de estado registrados.</p>
{% endif %}

<hr>

<a href="{% url 'home' %}">Volver al panel</a>

{% endblock %}
