{% extends "base.html" %}

{% block title %}
Incidex de {{ user.username }}
{% endblock %}

{% block content %}
    <h2>Menú de Incidencias</h2>

    {% if tipo_panel == 'usuario' %}

        <h3>Mis incidencias activas:</h3>

        {% if incidencias %}
            <ul>
            {% for incidencia in incidencias %}
                <li>
                    <a href="{% url 'detalle_incidencia' incidencia.id %}">
                        {{ incidencia.titulo }}
                    </a>
                    – {{ incidencia.get_estado_display }} ({{ incidencia.get_criticidad_display }})
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No tienes incidencias activas.</p>
        {% endif %}

        <h3>Historial de incidencias cerradas:</h3>

        {% if incidencias_cerradas %}
            <ul>
            {% for incidencia in incidencias_cerradas %}
                <li>
                    <a href="{% url 'detalle_incidencia' incidencia.id %}">
                        {{ incidencia.titulo }}
                    </a>
                    – Cerrada
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No tienes incidencias cerradas.</p>
        {% endif %}

        <a href="{% url 'crear_incidencia' %}">Crear nueva incidencia</a>

    {% elif tipo_panel == 'tecnico' %}

        <h3>Incidencias disponibles:</h3>

        {% if incidencias_disponibles %}
            <ul>
            {% for incidencia in incidencias_disponibles %}
                <li>
                    <a href="{% url 'detalle_incidencia' incidencia.id %}">
                        {{ incidencia.titulo }}
                    </a>
                    – {{ incidencia.get_criticidad_display }}
                    <form method="post"
                          action="{% url 'autoasignar_incidencia' incidencia.id %}"
                          style="display:inline;">
                        {% csrf_token %}
                        <button type="submit">Asignar</button>
                    </form>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No hay incidencias disponibles.</p>
        {% endif %}

        <h3>Mis incidencias asignadas:</h3>

        {% if incidencias_asignadas %}
            <ul>
            {% for incidencia in incidencias_asignadas %}
                <li>
                    <a href="{% url 'detalle_incidencia' incidencia.id %}">
                        {{ incidencia.titulo }}
                    </a>
                    – Estado actual: {{ incidencia.get_estado_display }}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No tienes incidencias asignadas activas.</p>
        {% endif %}

        <h3>Historial de incidencias cerradas:</h3>

        {% if incidencias_cerradas %}
            <ul>
            {% for incidencia in incidencias_cerradas %}
                <li>
                    <a href="{% url 'detalle_incidencia' incidencia.id %}">
                        {{ incidencia.titulo }}
                    </a>
                    – Cerrada
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No tienes incidencias cerradas.</p>
        {% endif %}

    {% elif tipo_panel == 'admin' %}

        <h3>Incidencias activas:</h3>

        {% if incidencias %}
            <ul>
            {% for incidencia in incidencias %}
                <li>
                    <a href="{% url 'detalle_incidencia' incidencia.id %}">
                        {{ incidencia.titulo }}
                    </a>
                    – {{ incidencia.get_estado_display }}
                    – {{ incidencia.get_tipo_incidencia_display }}
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No hay incidencias activas.</p>
        {% endif %}

        <h3>Historial global de incidencias cerradas:</h3>

        {% if incidencias_cerradas %}
            <ul>
            {% for incidencia in incidencias_cerradas %}
                <li>
                    <a href="{% url 'detalle_incidencia' incidencia.id %}">
                        {{ incidencia.titulo }}
                    </a>
                    – Cerrada
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No hay incidencias cerradas.</p>
        {% endif %}

    {% else %}

        <p>No tienes un perfil válido configurado.</p>

    {% endif %}
{% endblock %}
