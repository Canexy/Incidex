{% extends "base.html" %}

{% block title %}Inicio | Incidex{% endblock %}

{% block content %}

<h2>Panel principal</h2>

{% if tipo_panel == 'usuario' %}
    <a href="{% url 'crear_incidencia' %}">Crear nueva incidencia</a>

    <h3>Mis incidencias</h3>

    {% if incidencias %}
        <ul>
        {% for inc in incidencias %}
            <li>
                <a href="{% url 'detalle_incidencia' inc.id %}">
                    {{ inc.titulo }}
                </a>
                – {{ inc.estado }} ({{ inc.criticidad }})
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No tienes incidencias registradas.</p>
    {% endif %}

{% elif tipo_panel == 'tecnico' %}
    <h3>Incidencias disponibles</h3>

    {% if incidencias_disponibles %}
        <ul>
        {% for inc in incidencias_disponibles %}
            <li>
                <a href="{% url 'detalle_incidencia' inc.id %}">
                    {{ inc.titulo }}
                </a>
                – {{ inc.criticidad }}

                <form method="post"
                      action="{% url 'autoasignar_incidencia' inc.id %}"
                      style="display:inline;">
                    {% csrf_token %}
                    <button type="submit">Asignarme</button>
                </form>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No hay incidencias disponibles.</p>
    {% endif %}

    <h3>Mis incidencias asignadas</h3>

    {% if incidencias_asignadas %}
        <ul>
        {% for inc in incidencias_asignadas %}
            <li>
                <strong>
                    <a href="{% url 'detalle_incidencia' inc.id %}">
                        {{ inc.titulo }}
                    </a>
                </strong>
                – Estado actual: {{ inc.estado }}

                <form method="post"
                      action="{% url 'cambiar_estado_incidencia' inc.id %}">
                    {% csrf_token %}
                    <select name="estado">
                        <option value="">-- Cambiar estado --</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="en_espera">En espera</option>
                        <option value="resuelto">Resuelto</option>
                        <option value="cerrado">Cerrado</option>
                    </select>
                    <button type="submit">Actualizar</button>
                </form>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No tienes incidencias asignadas.</p>
    {% endif %}

{% elif tipo_panel == 'admin' %}
    <h3>Todas las incidencias</h3>

    <ul>
    {% for inc in incidencias %}
        <li>
            <a href="{% url 'detalle_incidencia' inc.id %}">
                {{ inc.titulo }}
            </a>
            – {{ inc.estado }} – {{ inc.tipo_incidencia }}
        </li>
    {% endfor %}
    </ul>

{% else %}
    <p>No tienes un perfil válido configurado.</p>
{% endif %}

{% endblock %}
